<%- layout('layout') %>

<h2>Отчет по местоположению и сотруднику</h2>

<!-- Форма фильтрации -->
<div class="report-filters">
    <h3>Фильтры</h3>
    <form action="/reports/by-location-employee" method="GET">
        <label for="locationId">Местоположение:</label>
        <select id="locationId" name="locationId" required>
            <option value="">-- Выберите местоположение --</option>
            <% locations.forEach(loc => { %>
                <option value="<%= loc.id %>" <%= currentFilters.locationId == loc.id ? 'selected' : '' %>><%= loc.name %></option>
            <% }) %>
        </select>
        <button type="submit">Сформировать</button>
    </form>
</div>

<% if (!reportData || reportData.length === 0) { %>
    <p>Нет данных для отображения по заданным критериям.</p>
<% } else { %>
    <%
       // Создаем объект для группировки данных по сотрудникам
       const groupedData = {};
       reportData.forEach(item => {
           if (!groupedData[item.responsible_employee]) {
               groupedData[item.responsible_employee] = [];
           }
           groupedData[item.responsible_employee].push(item);
       });
    %>

    <h3><%= reportData[0].location_name %></h3> <!-- Выводим название местоположения -->

    <% for (const employee in groupedData) { %>
        <h4><%= employee || "Не указан" %></h4> <!-- Выводим имя сотрудника -->
        <table>
            <thead>
                <tr>
                    <th>Инвентарный номер</th>
                    <th>Наименование</th>
                    <th>Кол-во</th>
                </tr>
            </thead>
            <tbody>
                <% groupedData[employee].forEach(item => { %>
                    <tr>
                        <td><%= item.inventory_number || '-' %></td>
                        <td><%= item.item_name %></td>
                        <td><%= item.total_items %></td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    <% } %>
<% } %>

<br>
<a href="/reports">К списку отчетов</a>