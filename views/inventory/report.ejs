<%- include('../partials/header') %>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center no-print">
        <h5 class="card-title mb-0">
            Отчет по инвентаризации: <%= inventory.floor %> этаж - <%= inventory.classroom_name %>
            <small class="text-muted">- <%= inventory.name %></small>
        </h5>
        <div class="d-flex gap-2">
            <a href="/inventory" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> Назад
            </a>
            <button class="btn btn-primary btn-sm" onclick="window.print()">
                <i class="fas fa-print"></i> Печать отчета
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Заголовок для печати -->
        <div class="print-header" style="display: none;">
            <h3>Отчет по инвентаризации</h3>
            <div class="print-info">
                <div>
                    <strong>Аудитория:</strong> <%= inventory.floor %> этаж - <%= inventory.classroom_name %><br>
                    <strong>Инвентаризация:</strong> <%= inventory.name %>
                </div>
                <div>
                    <strong>Дата создания:</strong> <%= new Date(inventory.created_at).toLocaleDateString('ru-RU') %><br>
                    <% if (inventory.completed_at) { %>
                    <strong>Дата завершения:</strong> <%= new Date(inventory.completed_at).toLocaleDateString('ru-RU') %>
                    <% } %>
                </div>
            </div>
            <% if (inventory.description) { %>
            <div style="margin-top: 10px;">
                <strong>Описание:</strong> <%= inventory.description %>
            </div>
            <% } %>
        </div>

        <!-- Информация об инвентаризации (только для экрана) -->
        <div class="row mb-4 no-print">
            <div class="col-md-6">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td><strong>Аудитория:</strong></td>
                        <td><%= inventory.floor %> этаж - <%= inventory.classroom_name %></td>
                    </tr>
                    <tr>
                        <td><strong>Дата создания:</strong></td>
                        <td><%= new Date(inventory.created_at).toLocaleDateString('ru-RU') %></td>
                    </tr>
                    <% if (inventory.completed_at) { %>
                    <tr>
                        <td><strong>Дата завершения:</strong></td>
                        <td><%= new Date(inventory.completed_at).toLocaleDateString('ru-RU') %></td>
                    </tr>
                    <% } %>
                    <% if (inventory.description) { %>
                    <tr>
                        <td><strong>Описание:</strong></td>
                        <td><%= inventory.description %></td>
                    </tr>
                    <% } %>
                </table>
            </div>
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">Статистика проверки</h6>
                        <div class="row">
                            <div class="col-3">
                                <h4 class="text-primary"><%= stats.total %></h4>
                                <small>Всего</small>
                            </div>
                            <div class="col-3">
                                <h4 class="text-success"><%= stats.match %></h4>
                                <small>Совпадает</small>
                            </div>
                            <div class="col-3">
                                <h4 class="text-warning"><%= stats.deficit %></h4>
                                <small>Недостача</small>
                            </div>
                            <div class="col-3">
                                <h4 class="text-info"><%= stats.surplus %></h4>
                                <small>Излишки</small>
                            </div>
                        </div>
                        <% if (stats.additional > 0) { %>
                        <div class="row mt-2">
                            <div class="col-12">
                                <h5 class="text-success"><%= stats.additional %></h5>
                                <small>Доп. оборудование</small>
                            </div>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статистика для печати -->
        <div class="print-stats" style="display: none;">
            <div>
                <h4><%= stats.total %></h4>
                <div>Всего</div>
            </div>
            <div>
                <h4><%= stats.match %></h4>
                <div>Совпадает</div>
            </div>
            <div>
                <h4><%= stats.deficit %></h4>
                <div>Недостача</div>
            </div>
            <div>
                <h4><%= stats.surplus %></h4>
                <div>Излишки</div>
            </div>
            <% if (stats.additional > 0) { %>
            <div style="grid-column: 1 / -1; margin-top: 5px;">
                <strong>Дополнительное оборудование:</strong> <%= stats.additional %> позиций
            </div>
            <% } %>
        </div>

        <!-- Основная таблица оборудования -->
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>№</th>
                        <th>Оборудование</th>
                        <th>Тип</th>
                        <th>Инв. номер</th>
                        <th>Ожидается</th>
                        <th>Фактически</th>
                        <th>Расхождение</th>
                        <th>Статус</th>
                        <th>Примечание</th>
                    </tr>
                </thead>
                <tbody>
                    <% results.forEach((item, index) => { %>
                        <tr>
                            <td><strong><%= index + 1 %></strong></td>
                            <td>
                                <strong><%= item.equipment_name %></strong>
                                <% if (item.serial_number) { %>
                                    <br>
                                    <small class="text-muted">S/N: <%= item.serial_number %></small>
                                <% } %>
                            </td>
                            <td>
                                <span class="badge bg-secondary"><%= item.type_name %></span>
                            </td>
                            <td>
                                <% if (item.inventory_number) { %>
                                    <code><%= item.inventory_number %></code>
                                <% } else { %>
                                    <span class="text-muted">—</span>
                                <% } %>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark"><%= item.expected_quantity %> шт.</span>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark"><%= item.actual_quantity %> шт.</span>
                            </td>
                            <td>
                                <% 
                                    const difference = item.actual_quantity - item.expected_quantity;
                                    if (difference === 0) { %>
                                        <span class="text-success">±0</span>
                                <% } else if (difference > 0) { %>
                                        <span class="text-success">+<%= difference %></span>
                                <% } else { %>
                                        <span class="text-danger"><%= difference %></span>
                                <% } %>
                            </td>
                            <td>
                                <span class="badge 
                                    <%= item.status === 'match' ? 'bg-success' : '' %>
                                    <%= item.status === 'deficit' ? 'bg-warning' : '' %>
                                    <%= item.status === 'surplus' ? 'bg-info' : '' %>">
                                    <%= 
                                        item.status === 'match' ? 'Совпадает' :
                                        item.status === 'deficit' ? 'Недостача' :
                                        item.status === 'surplus' ? 'Излишек' : item.status
                                    %>
                                </span>
                            </td>
                            <td>
                                <%= item.note || '—' %>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>

        <!-- Дополнительное оборудование -->
        <% if (additionalItems.length > 0) { %>
        <div class="card mt-4 border-success no-print">
            <div class="card-header bg-success text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-plus-circle"></i> Дополнительное оборудование (обнаружено при инвентаризации)
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Тип</th>
                                <th>Количество</th>
                                <th>Примечание</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% additionalItems.forEach(item => { %>
                                <tr>
                                    <td><strong><%= item.name %></strong></td>
                                    <td>
                                        <span class="badge bg-secondary"><%= item.type_name %></span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success"><%= item.quantity %> шт.</span>
                                    </td>
                                    <td><%= item.note || '—' %></td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-info mt-3">
                    <strong>Рекомендация:</strong> Добавьте это оборудование в систему для дальнейшего учета.
                </div>
            </div>
        </div>

        <!-- Дополнительное оборудование для печати -->
        <div class="page-break" style="display: none;"></div>
        <div class="print-summary" style="display: none;">
            <h6>Дополнительное оборудование (обнаружено при инвентаризации)</h6>
            <table class="table table-bordered" style="width: 100%; margin-top: 10px;">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Тип</th>
                        <th>Количество</th>
                        <th>Примечание</th>
                    </tr>
                </thead>
                <tbody>
                    <% additionalItems.forEach(item => { %>
                        <tr>
                            <td><strong><%= item.name %></strong></td>
                            <td><%= item.type_name %></td>
                            <td><%= item.quantity %> шт.</td>
                            <td><%= item.note || '—' %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
            <div style="margin-top: 10px; font-style: italic;">
                <strong>Рекомендация:</strong> Добавьте это оборудование в систему для дальнейшего учета.
            </div>
        </div>
        <% } %>

        <!-- Сводка по расхождениям (только для экрана) -->
        <% if (stats.deficit > 0 || stats.surplus > 0) { %>
            <div class="card border-warning mt-4 no-print">
                <div class="card-header bg-warning text-dark">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Сводка по расхождениям
                    </h6>
                </div>
                <div class="card-body">
                    <% if (stats.deficit > 0) { %>
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-minus-circle"></i> Недостача оборудования:</h6>
                            <ul>
                                <% results.filter(r => r.status === 'deficit').forEach(item => { %>
                                    <li>
                                        <strong><%= item.equipment_name %></strong> 
                                        - ожидалось: <%= item.expected_quantity %> шт., 
                                        фактически: <%= item.actual_quantity %> шт.
                                        (недостача: <%= item.expected_quantity - item.actual_quantity %> шт.)
                                    </li>
                                <% }); %>
                            </ul>
                        </div>
                    <% } %>
                    
                    <% if (stats.surplus > 0) { %>
                        <div class="alert alert-info">
                            <h6><i class="fas fa-plus-circle"></i> Излишки оборудования:</h6>
                            <ul>
                                <% results.filter(r => r.status === 'surplus').forEach(item => { %>
                                    <li>
                                        <strong><%= item.equipment_name %></strong> 
                                        - ожидалось: <%= item.expected_quantity %> шт., 
                                        фактически: <%= item.actual_quantity %> шт.
                                        (излишек: <%= item.actual_quantity - item.expected_quantity %> шт.)
                                    </li>
                                <% }); %>
                            </ul>
                        </div>
                    <% } %>
                </div>
            </div>
        <% } %>

        <!-- Сводка по расхождениям для печати -->
        <% if (stats.deficit > 0 || stats.surplus > 0) { %>
        <div class="print-summary" style="display: none;">
            <h6>Сводка по расхождениям</h6>
            <% if (stats.deficit > 0) { %>
            <div style="margin-bottom: 15px;">
                <strong>Недостача оборудования:</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <% results.filter(r => r.status === 'deficit').forEach(item => { %>
                        <li>
                            <strong><%= item.equipment_name %></strong> 
                            - ожидалось: <%= item.expected_quantity %> шт., 
                            фактически: <%= item.actual_quantity %> шт.
                            (недостача: <%= item.expected_quantity - item.actual_quantity %> шт.)
                        </li>
                    <% }); %>
                </ul>
            </div>
            <% } %>
            
            <% if (stats.surplus > 0) { %>
            <div>
                <strong>Излишки оборудования:</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <% results.filter(r => r.status === 'surplus').forEach(item => { %>
                        <li>
                            <strong><%= item.equipment_name %></strong> 
                            - ожидалось: <%= item.expected_quantity %> шт., 
                            фактически: <%= item.actual_quantity %> шт.
                            (излишек: <%= item.actual_quantity - item.expected_quantity %> шт.)
                        </li>
                    <% }); %>
                </ul>
            </div>
            <% } %>
        </div>
        <% } %>

        <div class="text-center mt-4 no-print">
            <p class="text-muted">
                Отчет сгенерирован: <%= new Date().toLocaleDateString('ru-RU') %> в <%= new Date().toLocaleTimeString('ru-RU') %>
            </p>
        </div>

        <!-- Время генерации для печати -->
        <div class="text-center" style="display: none;">
            <p>
                Отчет сгенерирован: <%= new Date().toLocaleDateString('ru-RU') %> в <%= new Date().toLocaleTimeString('ru-RU') %>
            </p>
        </div>
                <div class="print-dater" style="display: none;">
            <p>
                <ul style="text-align: center;">
                Отчет сгенерирован: <%= new Date().toLocaleDateString('ru-RU') %> в <%= new Date().toLocaleTimeString('ru-RU') %>
            </ul></p>
        </div>
    </div>
</div>

<script>
// Показываем элементы для печати при загрузке (они скрыты по умолчанию)
document.addEventListener('DOMContentLoaded', function() {
    // При печати показываем специальные элементы
    window.addEventListener('beforeprint', function() {
        document.querySelectorAll('[style*="display: none"]').forEach(el => {
            if (el.classList.contains('print-header') || 
                el.classList.contains('print-stats') || 
                el.classList.contains('print-summary') ||
                el.classList.contains('print-dater') ) {
                el.style.display = 'grid';
            }
        });
    });
});
</script>

<%- include('../partials/footer') %>