<%- include('../partials/header') %>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Групповое добавление оборудования</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/equipment/group-add">
                    
                    <!-- Основные данные -->
                    <div class="mb-3">
                        <label for="base_name" class="form-label">Базовое наименование *</label>
                        <input type="text" class="form-control" id="base_name" name="base_name"
                               placeholder="Например: Персональный компьютер, Стул офисный"
                               required>
                        <div class="form-text">
                            Это название будет использоваться как основа для всех единиц оборудования
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="type_id" class="form-label">Тип оборудования *</label>
                                <select class="form-select" id="type_id" name="type_id" required>
                                    <option value="">Выберите тип</option>
                                    <% types.forEach(type => { %>
                                        <option value="<%= type.id %>"><%= type.name %></option>
                                    <% }); %>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="classroom_id" class="form-label">Аудитория *</label>
                                <select class="form-select" id="classroom_id" name="classroom_id" required>
                                    <option value="">Выберите аудиторию</option>
                                    <% classrooms.forEach(classroom => { %>
                                        <option value="<%= classroom.id %>">
                                            <%= classroom.floor %> этаж - <%= classroom.name %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Настройки группового добавления -->
                    <div class="card bg-light mb-3">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Настройки группового добавления</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="quantity" class="form-label">Количество *</label>
                                        <input type="number" class="form-control" id="quantity" name="quantity"
                                               value="1" min="1" max="100" required>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="inventory_prefix" class="form-label">Префикс инв. номера</label>
                                        <input type="text" class="form-control" id="inventory_prefix" name="inventory_prefix"
                                               placeholder="Например: PC-">
                                        <div class="form-text">
                                            Будет использоваться для генерации номеров
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="start_number" class="form-label">Начальный номер</label>
                                        <input type="number" class="form-control" id="start_number" name="start_number"
                                               value="1" min="1">
                                        <div class="form-text">
                                            Номер для первого устройства
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="naming_template" class="form-label">Шаблон наименования</label>
                                <select class="form-select" id="naming_template" name="naming_template">
                                    <option value="base_only">Только базовое наименование</option>
                                    <option value="with_number" selected>Базовое наименование + номер</option>
                                    <option value="custom">Произвольный шаблон</option>
                                </select>
                            </div>
                            
                            <div class="mb-3" id="custom_template_container" style="display: none;">
                                <label for="custom_template" class="form-label">Произвольный шаблон</label>
                                <input type="text" class="form-control" id="custom_template" name="custom_template"
                                       placeholder="Например: Компьютер №{n} ({prefix})">
                                <div class="form-text">
                                    Используйте {n} для номера, {prefix} для префикса, {base} для базового названия
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Общие настройки -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="status" class="form-label">Статус</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="active" selected>Активный</option>
                                    <option value="broken">Сломан</option>
                                    <option value="repair">В ремонте</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="purchase_date" class="form-label">Дата покупки</label>
                                <input type="date" class="form-control" id="purchase_date" name="purchase_date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="comment" class="form-label">Комментарий (для всех единиц)</label>
                        <textarea class="form-control" id="comment" name="comment" rows="3"
                                  placeholder="Общий комментарий для всех добавляемых единиц оборудования"></textarea>
                    </div>
                    
                    <!-- Предпросмотр -->
                    <div class="card mb-3" id="preview_card" style="display: none;">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Предпросмотр</h6>
                        </div>
                        <div class="card-body">
                            <div id="preview_content"></div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Добавить группу оборудования
                        </button>
                        <a href="/equipment" class="btn btn-secondary">Отмена</a>
                        <a href="/equipment/add" class="btn btn-outline-info">
                            <i class="fas fa-plus"></i> Одиночное добавление
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const namingTemplate = document.getElementById('naming_template');
    const customTemplateContainer = document.getElementById('custom_template_container');
    const previewCard = document.getElementById('preview_card');
    const previewContent = document.getElementById('preview_content');
    
    // Показ/скрытие поля произвольного шаблона
    namingTemplate.addEventListener('change', function() {
        if (this.value === 'custom') {
            customTemplateContainer.style.display = 'block';
        } else {
            customTemplateContainer.style.display = 'none';
        }
        updatePreview();
    });
    
    // Обновление предпросмотра при изменении полей
    const previewFields = ['base_name', 'quantity', 'inventory_prefix', 'start_number', 'naming_template', 'custom_template'];
    previewFields.forEach(field => {
        document.getElementById(field).addEventListener('input', updatePreview);
    });
    
    function updatePreview() {
        const baseName = document.getElementById('base_name').value;
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        const prefix = document.getElementById('inventory_prefix').value;
        const startNumber = parseInt(document.getElementById('start_number').value) || 1;
        const template = document.getElementById('naming_template').value;
        const customTemplate = document.getElementById('custom_template').value;
        
        if (!baseName) {
            previewCard.style.display = 'none';
            return;
        }
        
        let previewHTML = '<p class="text-muted">Будет создано оборудование:</p><ul class="list-group">';
        
        for (let i = 0; i < Math.min(quantity, 10); i++) {
            const currentNumber = startNumber + i;
            let equipmentName = baseName;
            let inventoryNumber = prefix ? `${prefix}${currentNumber}` : '';
            
            // Формируем название по выбранному шаблону
            if (template === 'with_number') {
                equipmentName = `${baseName} №${currentNumber}`;
            } else if (template === 'custom' && customTemplate) {
                equipmentName = customTemplate
                    .replace(/{n}/g, currentNumber)
                    .replace(/{prefix}/g, prefix)
                    .replace(/{base}/g, baseName);
            }
            
            previewHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                <span>${equipmentName}</span>
                ${inventoryNumber ? `<code>${inventoryNumber}</code>` : '<span class="text-muted">без инв. номера</span>'}
            </li>`;
        }
        
        if (quantity > 10) {
            previewHTML += `<li class="list-group-item text-center text-muted">
                ... и еще ${quantity - 10} единиц
            </li>`;
        }
        
        previewHTML += '</ul>';
        previewContent.innerHTML = previewHTML;
        previewCard.style.display = 'block';
    }
    
    // Инициализация предпросмотра
    updatePreview();
});
</script>

<%- include('../partials/footer') %>