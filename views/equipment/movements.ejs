<%- include('../partials/header') %>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            История перемещений оборудования
            <% if (movements.length > 0) { %>
                - <%= movements[0].name || movements[0].inventory_number || movements[0].serial_number || 'Оборудование ' + movements[0].equipment_id %>
            <% } %>
        </h5>
        <a href="/equipment" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Назад к списку
        </a>
    </div>
    <div class="card-body">
        <% if (movements.length > 0) { %>
            <!-- Информация об оборудовании -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Информация об оборудовании</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Наименование:</strong> <%= movements[0].name %>
                                </div>
                                <% if (movements[0].inventory_number) { %>
                                <div class="col-md-4">
                                    <strong>Инвентарный номер:</strong> <code><%= movements[0].inventory_number %></code>
                                </div>
                                <% } %>
                                <% if (movements[0].serial_number) { %>
                                <div class="col-md-4">
                                    <strong>Серийный номер:</strong> <%= movements[0].serial_number %>
                                </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Дата и время</th>
                            <th>Откуда</th>
                            <th>Куда</th>
                            <th>Причина перемещения</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% movements.forEach(movement => { %>
                            <tr>
                                <td>
                                    <i class="fas fa-calendar-alt text-muted me-2"></i>
                                    <%= new Date(movement.moved_at).toLocaleDateString('ru-RU') %>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-clock text-muted me-1"></i>
                                        <%= new Date(movement.moved_at).toLocaleTimeString('ru-RU') %>
                                    </small>
                                </td>
                                <td>
                                    <% if (movement.from_classroom_name) { %>
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-door-open me-1"></i>
                                            <%= movement.from_classroom_name %>
                                        </span>
                                    <% } else { %>
                                        <span class="text-muted">
                                            <i class="fas fa-times-circle me-1"></i>
                                            Не назначено
                                        </span>
                                    <% } %>
                                </td>
                                <td>
                                    <span class="badge bg-primary">
                                        <i class="fas fa-door-closed me-1"></i>
                                        <%= movement.to_classroom_name %>
                                    </span>
                                </td>
                                <td>
                                    <% if (movement.movement_reason && movement.movement_reason !== 'Не указана') { %>
                                        <span class="text-dark"><%= movement.movement_reason %></span>
                                    <% } else { %>
                                        <span class="text-muted">
                                            <i class="fas fa-minus-circle me-1"></i>
                                            Причина не указана
                                        </span>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            
            <!-- Статистика перемещений -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Статистика перемещений</h6>
                            <p class="card-text mb-1">
                                <strong>Всего перемещений:</strong> <%= movements.length %>
                            </p>
                            <p class="card-text mb-1">
                                <strong>Первое перемещение:</strong> 
                                <%= new Date(movements[movements.length-1].moved_at).toLocaleDateString('ru-RU') %>
                            </p>
                            <p class="card-text mb-0">
                                <strong>Последнее перемещение:</strong> 
                                <%= new Date(movements[0].moved_at).toLocaleDateString('ru-RU') %>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        <% } else { %>
            <div class="text-center py-4">
                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                <h5>История перемещений отсутствует</h5>
                <p class="text-muted">Для этого оборудования не зафиксировано перемещений между аудиториями.</p>
                <div class="mt-3">
                    <a href="/equipment" class="btn btn-primary me-2">
                        <i class="fas fa-arrow-left"></i> Назад к списку оборудования
                    </a>
                    <% if (equipment && equipment.id) { %>
                        <button class="btn btn-success move-from-history" 
                                data-id="<%= equipment.id %>"
                                data-name="<%= equipment.name %>">
                            <i class="fas fa-arrows-alt"></i> Переместить это оборудование
                        </button>
                    <% } %>
                </div>
            </div>
        <% } %>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработка кнопки перемещения со страницы истории
    document.querySelectorAll('.move-from-history').forEach(button => {
        button.addEventListener('click', function() {
            const equipmentId = this.getAttribute('data-id');
            window.location.href = '/equipment';
            
            // После загрузки страницы оборудования автоматически открыть модальное окно перемещения
            setTimeout(() => {
                const moveButton = document.querySelector(`.move-equipment[data-id="${equipmentId}"]`);
                if (moveButton) {
                    moveButton.click();
                }
            }, 500);
        });
    });
});
</script>

<%- include('../partials/footer') %>